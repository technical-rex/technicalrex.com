<!DOCTYPE html>
<html class="no-js">
<head>
	<meta charset="utf-8">
	
	<title>Stateless Authentication with Spring Security and JWT | Technical Rex</title>
	<meta name="description" content="As part of my lifelong study of REST APIs I have been learning more about avoiding shared state between the client and server. This week in particular I have...">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	<meta http-equiv="X-Frame-Options" content="sameorigin">

	<link rel="stylesheet" href="/css/main.css">

	<link rel="canonical" href="http://technicalrex.com/2015/02/20/stateless-authentication-with-spring-security-and-jwt">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">

	<!-- For IE 9 and below. ICO should be 32x32 pixels in size -->
<!--[if IE]><link rel="shortcut icon" href="/img/icons/favicon.ico"><![endif]-->

<!-- Touch Icons - iOS and Android 2.1+ 180x180 pixels in size. -->
<link rel="apple-touch-icon" href="/img/icons/apple-touch-icon.png">

<!-- Firefox, Chrome, Safari, IE 11+ and Opera. 196x196 pixels in size. -->
<link rel="icon" href="/img/icons/favicon.png">

	
<meta property="article:published_time" content="2015-02-20T00:00:00-04:00" />
<meta property="article:modified_time" content="2015-02-20T00:00:00-04:00" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Stateless Authentication with Spring Security and JWT " />
<meta property="og:url" content="http://technicalrex.com/2015/02/20/stateless-authentication-with-spring-security-and-jwt" />
<meta property="og:description" content="As part of my lifelong study of REST APIs I have been learning more about avoiding shared state between the client and server. This week in particular I have been learning about stateless authentic..." />
<meta property="og:site_name" content="Technical Rex" />
<meta property="og:locale" content="en_US" />

<meta property="og:image" content="http://technicalrex.com/img/posts/cookiemonster-nocookiesforyou.jpg" />
<link rel="image_src" href="http://technicalrex.com/img/posts/cookiemonster-nocookiesforyou.jpg" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@eriklgillespie" />
<meta name="twitter:creator" content="@eriklgillespie" />


</head>

<body>
  <div id="landscape">
    <header class="site-header">
	<div class="branding flow-nav">
		<h1 class="site-title">
			<a href="/">
				Technical Rex
			</a>
		</h1>
	</div>
	<nav class="site-nav flow-nav">
		<ul class="flow-nav">
			
			
			<li class="flow-nav">
				<a class="page-link" href="/about.html">About</a>
			</li>
			
			
			
			<li class="flow-nav">
				<a class="page-link" href="/apps.html">Apps</a>
			</li>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<li class="flow-nav">
				<a href="/feed.xml" title="">
					<i class="fa fa-fw fa-rss"></i>
				</a>
			</li>
		</ul>
	</nav>
</header>

    <div id="page-container">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block;width:320px;height:50px"
     data-ad-client="ca-pub-5353438818816835"
     data-ad-slot="2993999908"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

      <div class="underlay">
    <div class="content">
        <article>
            <header class="post-header">
                <h1 class="title">Stateless Authentication with Spring Security and JWT</h1>
                <p class="about">
                    Posted  by Erik Gillespie
                    on February 20, 2015
                </p>
            </header>
            <section class="post-content"><p><em>Update:</em> The code used for this tutorial is now <a href="https://github.com/technical-rex/spring-security-jwt">available on GitHub</a>! Peruse, fork, and clone as you see fit.</p>

<p>As part of my lifelong study of REST APIs I have been learning more about <a href="http://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm#sec_5_1_3">avoiding shared state</a> between the client and server. This week in particular I have been learning about stateless authentication and attempting to implement it in a skeleton Java app based on my <a href="/2014/08/11/creating-a-jersey-app-on-google-app-engine">Jersey on Google AppEngine tutorial</a>.</p>

<h2 id="overview">Overview</h2>

<p>The REST architectural style is interesting to me, but that alone is not why I want to implement a stateless authentication mechanism. Benefits that Roy Fielding states in his dissertation include reliability and scalability. When building a web application, reliability is important no matter how many users you have. Scalability is also important for even a meager number of users.</p>

<p>Another benefit of statelessness when building a RESTful web application that is important to me is testability. It is much easier to test endpoints without first having to go through a workflow to establish a session and then end that session after the test to ensure the tests are isolated. This will probably result in time savings during the development of the app as well.</p>

<p>One of the downsides of statelessness is that it requires some form of token or credential to be supplied with <strong>every</strong> request to the server, which can be a performance penalty. <a href="http://openid.net/specs/draft-jones-json-web-token-07.html">JWT</a> (JSON Web Tokens) are a means of offering stateless authentication in a compact and secure way. JSON Web Tokens can be used to thwart cross-site request forgery attempts and there are plenty of JWT libraries out there as well.</p>

<p>While there may be a performance penalty to stateless authentication, I think the compactful, secure, easy-to-use JWT balances out that con quite nicely. Another benefit of JWT is that it does not require the use of cookies, which makes server-to-server authentication more convenient.</p>

<div class="image-center">
    
    <img src="/img/posts/cookiemonster-nocookiesforyou.jpg" class="shadow" />
    
    No Cookies for You!
</div>

<h2 id="where-to-begin">Where to Begin</h2>

<p>I set out to use <a href="http://projects.spring.io/spring-security/">Spring Security</a> because it is very customizable and is usually not very invasive to the rest of your web application. I also have a lot of experience with it so it’s typically a good place for me to start when looking into any new security-related solutions.</p>

<p>Spring Security does offer <a href="https://github.com/spring-projects/spring-security-oauth/tree/master/spring-security-jwt">its own approach to JWT</a> too, but I decided not to use it because until recently it had not seen much activity. Instead, I chose to use <a href="https://github.com/jwtk/jjwt">JJWT</a>, which provides a brilliant fluent interface for using JSON Web Tokens.</p>

<p>After choosing my tech stack for this little project I perused the Internet to see if anyone had already accomplished what I was setting out to do. I found this <a href="http://blog.jdriven.com/2014/10/stateless-spring-security-part-2-stateless-authentication/">JDriven article</a> by Robbert van Waveren that comes pretty darn close. It turned out to be a great starting point!</p>

<p>The code provided below is an adaptation of Robbert’s tutorial to use JWT. I made some small changes to bootstrap the app in a Google AppEngine app instead of using Spring Boot so I’ll point out those differences as well.</p>

<h2 id="code-time">Code Time!</h2>

<p>First things first, let’s pull in the Maven dependencies for Spring Security and JJWT.</p>

<p><strong>pom.xml</strong></p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno"> 1</span> <span class="nt">&lt;dependency&gt;</span>
<span class="lineno"> 2</span>     <span class="nt">&lt;groupId&gt;</span>org.springframework.security<span class="nt">&lt;/groupId&gt;</span>
<span class="lineno"> 3</span>     <span class="nt">&lt;artifactId&gt;</span>spring-security-web<span class="nt">&lt;/artifactId&gt;</span>
<span class="lineno"> 4</span>     <span class="nt">&lt;version&gt;</span>3.2.5.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="lineno"> 5</span> <span class="nt">&lt;/dependency&gt;</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="nt">&lt;dependency&gt;</span>
<span class="lineno"> 8</span>     <span class="nt">&lt;groupId&gt;</span>org.springframework.security<span class="nt">&lt;/groupId&gt;</span>
<span class="lineno"> 9</span>     <span class="nt">&lt;artifactId&gt;</span>spring-security-config<span class="nt">&lt;/artifactId&gt;</span>
<span class="lineno">10</span>     <span class="nt">&lt;version&gt;</span>3.2.5.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="lineno">11</span> <span class="nt">&lt;/dependency&gt;</span>
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="nt">&lt;dependency&gt;</span>
<span class="lineno">14</span>     <span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
<span class="lineno">15</span>     <span class="nt">&lt;artifactId&gt;</span>jjwt<span class="nt">&lt;/artifactId&gt;</span>
<span class="lineno">16</span>     <span class="nt">&lt;version&gt;</span>0.4<span class="nt">&lt;/version&gt;</span>
<span class="lineno">17</span> <span class="nt">&lt;/dependency&gt;</span></code></pre></div>

<p>Since I’m using a Servlet 2.5 container running in Google AppEngine, I’ll have to configure the Spring Security filter in web.xml too.</p>

<p><strong>web.xml</strong></p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno"> 1</span> <span class="nt">&lt;context-param&gt;</span>
<span class="lineno"> 2</span>     <span class="nt">&lt;param-name&gt;</span>contextClass<span class="nt">&lt;/param-name&gt;</span>
<span class="lineno"> 3</span>     <span class="nt">&lt;param-value&gt;</span>
<span class="lineno"> 4</span>         org.springframework.web.context.support.AnnotationConfigWebApplicationContext
<span class="lineno"> 5</span>     <span class="nt">&lt;/param-value&gt;</span>
<span class="lineno"> 6</span> <span class="nt">&lt;/context-param&gt;</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="nt">&lt;context-param&gt;</span>
<span class="lineno"> 9</span>     <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
<span class="lineno">10</span>     <span class="nt">&lt;param-value&gt;</span>
<span class="lineno">11</span>         com.technicalrex.skeleton.vendor.SpringSecurityConfig
<span class="lineno">12</span>     <span class="nt">&lt;/param-value&gt;</span>
<span class="lineno">13</span> <span class="nt">&lt;/context-param&gt;</span>
<span class="lineno">14</span> 
<span class="lineno">15</span> <span class="nt">&lt;filter&gt;</span>
<span class="lineno">16</span>     <span class="nt">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="nt">&lt;/filter-name&gt;</span>
<span class="lineno">17</span>     <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="nt">&lt;/filter-class&gt;</span>
<span class="lineno">18</span> <span class="nt">&lt;/filter&gt;</span>
<span class="lineno">19</span> 
<span class="lineno">20</span> <span class="nt">&lt;filter-mapping&gt;</span>
<span class="lineno">21</span>     <span class="nt">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="nt">&lt;/filter-name&gt;</span>
<span class="lineno">22</span>     <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="lineno">23</span>     <span class="nt">&lt;dispatcher&gt;</span>REQUEST<span class="nt">&lt;/dispatcher&gt;</span>
<span class="lineno">24</span> <span class="nt">&lt;/filter-mapping&gt;</span>
<span class="lineno">25</span> 
<span class="lineno">26</span> <span class="nt">&lt;listener&gt;</span>
<span class="lineno">27</span>     <span class="nt">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="nt">&lt;/listener-class&gt;</span>
<span class="lineno">28</span> <span class="nt">&lt;/listener&gt;</span></code></pre></div>

<p>Now that Spring Security is bootstrapping I need to define the SpringSecurityConfig. This class will declare any security-related Spring beans and configure the base HTTP filter to secure the web application.</p>

<p><strong>SpringSecurityConfig.java</strong></p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="nd">@Configuration</span>
<span class="lineno"> 2</span> <span class="nd">@EnableWebSecurity</span>
<span class="lineno"> 3</span> <span class="nd">@Order</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
<span class="lineno"> 4</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringSecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>     <span class="kd">private</span> <span class="kd">final</span> <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>
<span class="lineno"> 7</span>     <span class="kd">private</span> <span class="kd">final</span> <span class="n">TokenAuthenticationService</span> <span class="n">tokenAuthenticationService</span><span class="o">;</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span>     <span class="kd">public</span> <span class="nf">SpringSecurityConfig</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">10</span>         <span class="kd">super</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="lineno">11</span>         <span class="k">this</span><span class="o">.</span><span class="na">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">UserService</span><span class="o">();</span>
<span class="lineno">12</span>         <span class="n">tokenAuthenticationService</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">TokenAuthenticationService</span><span class="o">(</span><span class="s">&quot;tooManySecrets&quot;</span><span class="o">,</span> <span class="n">userService</span><span class="o">);</span>
<span class="lineno">13</span>     <span class="o">}</span>
<span class="lineno">14</span> 
<span class="lineno">15</span>     <span class="nd">@Override</span>
<span class="lineno">16</span>     <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
<span class="lineno">17</span>         <span class="n">http</span>
<span class="lineno">18</span>                 <span class="o">.</span><span class="na">exceptionHandling</span><span class="o">().</span><span class="na">and</span><span class="o">()</span>
<span class="lineno">19</span>                 <span class="o">.</span><span class="na">anonymous</span><span class="o">().</span><span class="na">and</span><span class="o">()</span>
<span class="lineno">20</span>                 <span class="o">.</span><span class="na">servletApi</span><span class="o">().</span><span class="na">and</span><span class="o">()</span>
<span class="lineno">21</span>                 <span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">cacheControl</span><span class="o">().</span><span class="na">and</span><span class="o">()</span>
<span class="lineno">22</span>                 <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
<span class="lineno">23</span> 
<span class="lineno">24</span>                 <span class="c1">// Allow anonymous resource requests</span>
<span class="lineno">25</span>                 <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
<span class="lineno">26</span>                 <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&quot;/favicon.ico&quot;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
<span class="lineno">27</span>                 <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&quot;**/*.html&quot;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
<span class="lineno">28</span>                 <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&quot;**/*.css&quot;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
<span class="lineno">29</span>                 <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&quot;**/*.js&quot;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
<span class="lineno">30</span> 
<span class="lineno">31</span>                 <span class="c1">// Allow anonymous logins</span>
<span class="lineno">32</span>                 <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&quot;/auth/**&quot;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
<span class="lineno">33</span> 
<span class="lineno">34</span>                 <span class="c1">// All other request need to be authenticated</span>
<span class="lineno">35</span>                 <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">().</span><span class="na">and</span><span class="o">()</span>
<span class="lineno">36</span> 
<span class="lineno">37</span>                 <span class="c1">// Custom Token based authentication based on the header previously given to the client</span>
<span class="lineno">38</span>                 <span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="k">new</span> <span class="nf">StatelessAuthenticationFilter</span><span class="o">(</span><span class="n">tokenAuthenticationService</span><span class="o">),</span>
<span class="lineno">39</span>                         <span class="n">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="lineno">40</span>     <span class="o">}</span>
<span class="lineno">41</span> 
<span class="lineno">42</span>     <span class="nd">@Override</span>
<span class="lineno">43</span>     <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
<span class="lineno">44</span>         <span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userDetailsService</span><span class="o">()).</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">());</span>
<span class="lineno">45</span>     <span class="o">}</span>
<span class="lineno">46</span> 
<span class="lineno">47</span>     <span class="nd">@Bean</span>
<span class="lineno">48</span>     <span class="nd">@Override</span>
<span class="lineno">49</span>     <span class="kd">public</span> <span class="n">AuthenticationManager</span> <span class="nf">authenticationManagerBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
<span class="lineno">50</span>         <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">authenticationManagerBean</span><span class="o">();</span>
<span class="lineno">51</span>     <span class="o">}</span>
<span class="lineno">52</span> 
<span class="lineno">53</span>     <span class="nd">@Bean</span>
<span class="lineno">54</span>     <span class="nd">@Override</span>
<span class="lineno">55</span>     <span class="kd">public</span> <span class="n">UserService</span> <span class="nf">userDetailsService</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">56</span>         <span class="k">return</span> <span class="n">userService</span><span class="o">;</span>
<span class="lineno">57</span>     <span class="o">}</span>
<span class="lineno">58</span> 
<span class="lineno">59</span>     <span class="nd">@Bean</span>
<span class="lineno">60</span>     <span class="kd">public</span> <span class="n">TokenAuthenticationService</span> <span class="nf">tokenAuthenticationService</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">61</span>         <span class="k">return</span> <span class="n">tokenAuthenticationService</span><span class="o">;</span>
<span class="lineno">62</span>     <span class="o">}</span>
<span class="lineno">63</span> <span class="o">}</span></code></pre></div>

<p>There are a number of important details in this class that are worth understanding:</p>

<ol>
  <li>In the constructor, disable the default security configuration.</li>
  <li>In the constructor the string “tooManySecrets” should be replaced with a value private to your application and ideally loaded from a property file.</li>
  <li>Anonymous access is allowed but authorization will happen on all HTTP requests.</li>
  <li>Prevent the browser/client from caching responses.</li>
  <li>Allow anonymous access to all static resources (HTML, CSS, JS, etc.).</li>
  <li>Also allow anonymous access to login attempts (this assumes logins are managed under /auth).</li>
  <li>Authentication must occur on requests to all other resources.</li>
  <li>A single filter will be used to authenticate all requests that require authentication.</li>
</ol>

<p>This configuration shows that there are a handful of other classes needed in order to implement stateless authentication. The filter is where the actual authentication is managed though so let’s look at that one first.</p>

<p><strong>StatelessAuthenticationFilter.java</strong></p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">StatelessAuthenticationFilter</span> <span class="kd">extends</span> <span class="n">GenericFilterBean</span> <span class="o">{</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>     <span class="kd">private</span> <span class="kd">final</span> <span class="n">TokenAuthenticationService</span> <span class="n">authenticationService</span><span class="o">;</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span>     <span class="kd">public</span> <span class="nf">StatelessAuthenticationFilter</span><span class="o">(</span><span class="n">TokenAuthenticationService</span> <span class="n">authenticationService</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 6</span>         <span class="k">this</span><span class="o">.</span><span class="na">authenticationService</span> <span class="o">=</span> <span class="n">authenticationService</span><span class="o">;</span>
<span class="lineno"> 7</span>     <span class="o">}</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span>     <span class="nd">@Override</span>
<span class="lineno">10</span>     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span>
<span class="lineno">11</span>             <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
<span class="lineno">12</span>         <span class="n">HttpServletRequest</span> <span class="n">httpRequest</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">;</span>
<span class="lineno">13</span>         <span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">authenticationService</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">(</span><span class="n">httpRequest</span><span class="o">);</span>
<span class="lineno">14</span>         <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
<span class="lineno">15</span>         <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
<span class="lineno">16</span>         <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
<span class="lineno">17</span>     <span class="o">}</span>
<span class="lineno">18</span> <span class="o">}</span></code></pre></div>

<p>There’s not much here because this filter actually delegates to <code>TokenAuthenticationService</code>. All this filter really does is apply the successful authentication to Spring Security’s context holder and then proceed with the request.</p>

<p>Okay, let’s dig a little deeper and look at <code>TokenAuthenticationService</code>.</p>

<p><strong>TokenAuthenticationService.java</strong></p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenAuthenticationService</span> <span class="o">{</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>     <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">AUTH_HEADER_NAME</span> <span class="o">=</span> <span class="s">&quot;X-AUTH-TOKEN&quot;</span><span class="o">;</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span>     <span class="kd">private</span> <span class="kd">final</span> <span class="n">TokenHandler</span> <span class="n">tokenHandler</span><span class="o">;</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="kd">public</span> <span class="nf">TokenAuthenticationService</span><span class="o">(</span><span class="n">String</span> <span class="n">secret</span><span class="o">,</span> <span class="n">UserService</span> <span class="n">userService</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>         <span class="n">tokenHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">TokenHandler</span><span class="o">(</span><span class="n">secret</span><span class="o">,</span> <span class="n">userService</span><span class="o">);</span>
<span class="lineno"> 9</span>     <span class="o">}</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addAuthentication</span><span class="o">(</span><span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">UserAuthentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">12</span>         <span class="kd">final</span> <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getDetails</span><span class="o">();</span>
<span class="lineno">13</span>         <span class="n">response</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="n">AUTH_HEADER_NAME</span><span class="o">,</span> <span class="n">tokenHandler</span><span class="o">.</span><span class="na">createTokenForUser</span><span class="o">(</span><span class="n">user</span><span class="o">));</span>
<span class="lineno">14</span>     <span class="o">}</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>     <span class="kd">public</span> <span class="n">Authentication</span> <span class="nf">getAuthentication</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">17</span>         <span class="kd">final</span> <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="n">AUTH_HEADER_NAME</span><span class="o">);</span>
<span class="lineno">18</span>         <span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">19</span>             <span class="kd">final</span> <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">tokenHandler</span><span class="o">.</span><span class="na">parseUserFromToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
<span class="lineno">20</span>             <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">21</span>                 <span class="k">return</span> <span class="k">new</span> <span class="nf">UserAuthentication</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
<span class="lineno">22</span>             <span class="o">}</span>
<span class="lineno">23</span>         <span class="o">}</span>
<span class="lineno">24</span>         <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">25</span>     <span class="o">}</span>
<span class="lineno">26</span> <span class="o">}</span></code></pre></div>

<p>This is where things start to become more clear about how authentication will actually work! When a user successfully logs into the web application, the first public method of this class will be called to create a token for that user. That token is then added as a header with the key “X-AUTH-TOKEN” to the outbound response.</p>

<p>The authentication filter is calling <code>getAuthentication(...)</code> though, which looks for a header that uses the same key “X-AUTH-TOKEN” and uses that token to re-establish the authenticating user. If this method throws an exception or returns <code>null</code> then the user will not be authenticated and the request will ultimately fail.</p>

<p>Robbert’s article conveniently delegated the token generation and parsing to yet another class to isolate that logic. My implementation of <code>TokenHandler</code> uses JJWT to manage a JSON Web Token. Here’s what it looks like:</p>

<p><strong>TokenHandler.java</strong></p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TokenHandler</span> <span class="o">{</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>     <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">secret</span><span class="o">;</span>
<span class="lineno"> 4</span>     <span class="kd">private</span> <span class="kd">final</span> <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>     <span class="kd">public</span> <span class="nf">TokenHandler</span><span class="o">(</span><span class="n">String</span> <span class="n">secret</span><span class="o">,</span> <span class="n">UserService</span> <span class="n">userService</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 7</span>         <span class="k">this</span><span class="o">.</span><span class="na">secret</span> <span class="o">=</span> <span class="n">secret</span><span class="o">;</span>
<span class="lineno"> 8</span>         <span class="k">this</span><span class="o">.</span><span class="na">userService</span> <span class="o">=</span> <span class="n">userService</span><span class="o">;</span>
<span class="lineno"> 9</span>     <span class="o">}</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>     <span class="kd">public</span> <span class="n">User</span> <span class="nf">parseUserFromToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">12</span>         <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">()</span>
<span class="lineno">13</span>                 <span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">secret</span><span class="o">)</span>
<span class="lineno">14</span>                 <span class="o">.</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">)</span>
<span class="lineno">15</span>                 <span class="o">.</span><span class="na">getBody</span><span class="o">()</span>
<span class="lineno">16</span>                 <span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
<span class="lineno">17</span>         <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">loadUserByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
<span class="lineno">18</span>     <span class="o">}</span>
<span class="lineno">19</span> 
<span class="lineno">20</span>     <span class="kd">public</span> <span class="n">String</span> <span class="nf">createTokenForUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">21</span>         <span class="k">return</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
<span class="lineno">22</span>                 <span class="o">.</span><span class="na">setSubject</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">())</span>
<span class="lineno">23</span>                 <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="n">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS512</span><span class="o">,</span> <span class="n">secret</span><span class="o">)</span>
<span class="lineno">24</span>                 <span class="o">.</span><span class="na">compact</span><span class="o">();</span>
<span class="lineno">25</span>     <span class="o">}</span>
<span class="lineno">26</span> <span class="o">}</span></code></pre></div>

<p>This is where the magic of JJWT happens. In a single chain of calls to its fluent API, JJWT will create a token using the subject of our choosing (username) and sign it using the application’s secret key. All of the other work of generating appropriately structured JSON according to the even more specific JWT specification, Base 64 encoding, and compaction are all taken care of behind the scenes.</p>

<p>The reverse is true too. JJWT can also use a secret key to fully decode and parse a JSON Web Token and provide an object that we can use to later retrieve the subject (username) needed to verify the presence of a real user.</p>

<p>The only remaining classes are nothing special (they’ll be needed in many Spring Security applications that involve a user login) so I will provide them below for completeness.</p>

<p><strong>UserService.java</strong></p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="kd">implements</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">userdetails</span><span class="o">.</span><span class="na">UserDetailsService</span> <span class="o">{</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>     <span class="kd">private</span> <span class="kd">final</span> <span class="n">AccountStatusUserDetailsChecker</span> <span class="n">detailsChecker</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AccountStatusUserDetailsChecker</span><span class="o">();</span>
<span class="lineno"> 4</span>     <span class="kd">private</span> <span class="kd">final</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">userMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;();</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>     <span class="nd">@Override</span>
<span class="lineno"> 7</span>     <span class="kd">public</span> <span class="kd">final</span> <span class="n">User</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="o">{</span>
<span class="lineno"> 8</span>         <span class="kd">final</span> <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
<span class="lineno"> 9</span>         <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">10</span>             <span class="k">throw</span> <span class="k">new</span> <span class="nf">UsernameNotFoundException</span><span class="o">(</span><span class="s">&quot;user not found&quot;</span><span class="o">);</span>
<span class="lineno">11</span>         <span class="o">}</span>
<span class="lineno">12</span>         <span class="n">detailsChecker</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
<span class="lineno">13</span>         <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
<span class="lineno">14</span>     <span class="o">}</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">17</span>         <span class="n">userMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">user</span><span class="o">);</span>
<span class="lineno">18</span>     <span class="o">}</span>
<span class="lineno">19</span> <span class="o">}</span></code></pre></div>

<p>This implementation of Spring Security’s <code>UserDetailsService</code> is for demonstration purposes only! It uses a map to maintain the set of available users and it isn’t even thread safe. If you are using this tutorial you will most certainly want to replace this with a user lookup service that uses a database, LDAP, or some other more legitimate means of keeping track of users.</p>

<p><strong>UserAuthentication.java</strong></p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserAuthentication</span> <span class="kd">implements</span> <span class="n">Authentication</span> <span class="o">{</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>     <span class="kd">private</span> <span class="kd">final</span> <span class="n">User</span> <span class="n">user</span><span class="o">;</span>
<span class="lineno"> 4</span>     <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">authenticated</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>     <span class="kd">public</span> <span class="nf">UserAuthentication</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 7</span>         <span class="k">this</span><span class="o">.</span><span class="na">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">;</span>
<span class="lineno"> 8</span>     <span class="o">}</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>     <span class="nd">@Override</span>
<span class="lineno">11</span>     <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">12</span>         <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
<span class="lineno">13</span>     <span class="o">}</span>
<span class="lineno">14</span> 
<span class="lineno">15</span>     <span class="nd">@Override</span>
<span class="lineno">16</span>     <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">17</span>         <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">();</span>
<span class="lineno">18</span>     <span class="o">}</span>
<span class="lineno">19</span> 
<span class="lineno">20</span>     <span class="nd">@Override</span>
<span class="lineno">21</span>     <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getCredentials</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">22</span>         <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
<span class="lineno">23</span>     <span class="o">}</span>
<span class="lineno">24</span> 
<span class="lineno">25</span>     <span class="nd">@Override</span>
<span class="lineno">26</span>     <span class="kd">public</span> <span class="n">User</span> <span class="nf">getDetails</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">27</span>         <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
<span class="lineno">28</span>     <span class="o">}</span>
<span class="lineno">29</span> 
<span class="lineno">30</span>     <span class="nd">@Override</span>
<span class="lineno">31</span>     <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getPrincipal</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">32</span>         <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
<span class="lineno">33</span>     <span class="o">}</span>
<span class="lineno">34</span> 
<span class="lineno">35</span>     <span class="nd">@Override</span>
<span class="lineno">36</span>     <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAuthenticated</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">37</span>         <span class="k">return</span> <span class="n">authenticated</span><span class="o">;</span>
<span class="lineno">38</span>     <span class="o">}</span>
<span class="lineno">39</span> 
<span class="lineno">40</span>     <span class="nd">@Override</span>
<span class="lineno">41</span>     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAuthenticated</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">authenticated</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">42</span>         <span class="k">this</span><span class="o">.</span><span class="na">authenticated</span> <span class="o">=</span> <span class="n">authenticated</span><span class="o">;</span>
<span class="lineno">43</span>     <span class="o">}</span>
<span class="lineno">44</span> <span class="o">}</span></code></pre></div>

<p>This class implements Spring Security’s <code>Authentication</code> interface, which is how Spring ties users, authorities/roles, principals, credentials, and authentication status together. The implementation above always assumes the user is authenticated and delegates the rest to Spring Security’s own <code>User</code> class.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Robbert van Waveren’s article saved me from a lot of the grunt work of configuring Spring Security to handle stateless authentication. Swapping out his own HMAC signing code with the one-liners offered up by JJWT helped me cut out a lot of code and use a full-blown JWT implementation as well!</p>

<p>All in all, this is probably one of the smallest Spring Security implementations that I have done. I don’t know why I didn’t try this out sooner!</p>
</section>
            <p class="signature"> - Erik</p>
        </article>
    </div>
</div>

    </div>
    <footer class="site-footer">
	<p class="text">Copyright © 2015 Technical Rex, Inc. Re-use with attribution encouraged. All other rights reserved.</p>
</footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-62666024-3', 'auto');
ga('send', 'pageview');
</script>



  </div>
  <img id="rex" src="/img/rex/rex-main.png"></img>
  <script type="text/javascript" src="/js/retarget-links.js"></script>
</body>
</html>
